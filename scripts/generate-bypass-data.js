#!/usr/bin/env node

import { readFileSync, writeFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

const tsvPath = join(__dirname, '..', 'data', 'csp-bypass-data.tsv');
const outputPath = join(__dirname, '..', 'packages', 'backend', 'src', 'bypass-data.generated.ts');

try {
  const tsvContent = readFileSync(tsvPath, 'utf-8');
  const lines = tsvContent.trim().split('\n');
  const entryCount = Math.max(0, lines.length - 1);

  const escapedContent = tsvContent
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$');

  const generatedFile = `// Auto-generated file - do not edit manually
// Generated from data/csp-bypass-data.tsv
// Contains ${entryCount} CSP bypass entries

export const CSP_BYPASS_TSV_DATA = \`${escapedContent}\`;

export const BYPASS_ENTRY_COUNT = ${entryCount};
`;

  writeFileSync(outputPath, generatedFile, 'utf-8');
  console.log(`Generated bypass data file with ${entryCount} entries`);
} catch (error) {
  console.error('Failed to generate bypass data file:', error);
  process.exit(1);
}
